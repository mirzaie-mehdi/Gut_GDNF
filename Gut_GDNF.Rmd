---
title: "Gut_GDNF"
output: html_document
date: "2023-08-23"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Read Data

In this project we use two single cell RNA-seq data sets which can be downloaded from
For human:
https://www.gutcellatlas.org/

For mice:
https://www.ncbi.nlm.nih.gov/geo/query/acc.cgi?acc=GSE149524

GSE149524



## library
```{r library}
library(ggplot2)
library(dplyr)
library(reshape2)
library(ggpubr)
library(tidyverse)
```

## Read data

The data sets 
```{r read_data, echo=FALSE}
mice_e15 <- readRDS("data/rds/normExp_MiceE15.rds")
human_sec_trim <- readRDS("data/rds/normExp_HumanSecondTrim.rds")

```

## Mice

```{r}
miceA <- mice_e15[mice_e15$Branch=="Branch A",-c(13,14)] # There are 2127 cells.
num_genes = ncol(miceA)
p_value_matrix <- matrix(NA, nrow = num_genes, ncol = num_genes)
cor_matrix = p_value_matrix
for (i in 1:num_genes) {
  gene1 = gene_names[i] 
  for (j in 1:num_genes) {
        x <- miceA[,i]
        y <- miceA[,j]
        gene2 = gene_names[j] 
        non_zero_indices <- which(x != 0 & y != 0)
        x_non_zero <- x[non_zero_indices]
        y_non_zero <- y[non_zero_indices]
        df = data.frame(x=x_non_zero, y=y_non_zero)
        if (i>j){
          sc <- ggplot(df, aes(x = x, y = y)) +
                geom_point() +
            ggtitle(paste("Mice Branch A, Number of cells = ", length(x_non_zero), sep = "")) +
                xlim(.01,max(x_non_zero)) + ylim(.01,max(y_non_zero)) +
                labs(x = gene1,y = gene2) +
                theme_light(base_line_size = 0) +
                stat_cor(method = "pearson", size=5, color = "red", geom = "label") +
                theme(axis.title = element_text(size = 20,face = 'bold'),
                axis.text = element_text(size = 15,face = 'bold'))
                # Save the plot
                file_name <- paste("MiceA_",  gene1, "_vs_", gene2, ".png", sep = "")
                ggsave(file_name, sc)
        }
        if (length(x_non_zero)>2){
           c <- cor.test(x_non_zero, y_non_zero,method = "pearson")
           p_value_matrix[i, j] <- c$p.value
           cor_matrix[i, j] <- c$estimate
        }
#    p_value_matrix[i, j] <- cor.test(miceA[, i], miceA[, j],method = "spearman",exact = FALSE)$p.value
#    cor_matrix[i, j] <- cor.test(miceA[, i], miceA[, j],method = "spearman",exact = FALSE)$estimate
  }
}
rownames(p_value_matrix) = rownames(cor_matrix) = colnames(p_value_matrix) = colnames(cor_matrix) = colnames(miceA)

```

## Visualization_BranchA_mice

```{r}
p_value <- p_value_matrix
p_value[upper.tri(p_value,diag =T)] <- NA
corr <- cor_matrix
corr[upper.tri(corr,diag =T)] <- NA
p_value_r = na.omit(melt(p_value))
corr_r = na.omit(melt(corr))
p_val_corr <- merge(p_value_r,corr_r,by = c("Var1","Var2"))
colnames(p_val_corr) = c("gene1","gene2","P-Value","Corr")
p_val_corr$L10p = round(-log10(p_val_corr$`P-Value`),1)
g = ggplot(p_val_corr)+
  geom_tile(aes(x=gene1,y=gene2, fill = Corr),colour = "black", show.legend = TRUE) +
  geom_text(aes(x=gene1,y=gene2, label=ifelse(!is.na(L10p),paste0("10^-",L10p),NA)),
            parse = T,size=6,fontface="bold")+
  scale_fill_gradient2(mid="white",limits=c(-1,1),na.value = 'gray80',
                       high="#DC0000B2", low="#3C5488B2") +
 theme_test() + 
  ggtitle("Mice_Branch A, Number of Cells = 2127") +
  theme(axis.title = element_blank(),
        axis.text = element_text( face = "bold",size = 14),
        legend.position = "bottom",
        legend.title = element_text( face = "bold",size = 12),
        legend.text = element_text( face = "bold",size = 10),
        plot.title = element_text(hjust = 0.5, margin = margin(b = 5), face = "bold",size = 14 ))

```

## Human

```{r}
humanA <- human_sec_trim[human_sec_trim$Branch=="Branch A",-c(13,14)] # There are 365 cells.
num_genes = ncol(humanA)
p_value_matrix <- matrix(NA, nrow = num_genes, ncol = num_genes)
cor_matrix = p_value_matrix
gene_names <- colnames(humanA)
for (i in 1:num_genes) {
  gene1 = gene_names[i] 
  for (j in 1:num_genes) {
    gene2 = gene_names[j] 
    x <- humanA[,i]
    y <- humanA[,j]
    non_zero_indices <- which(x != 0 & y != 0)
    x_non_zero <- x[non_zero_indices]
    y_non_zero <- y[non_zero_indices]
    df = data.frame(x=x_non_zero, y=y_non_zero)
    if (i>j){
      sc <- ggplot(df, aes(x = x, y = y)) +
      geom_point() +
      ggtitle(paste("Human Branch A, Number of cells = ", length(x_non_zero), sep = "")) +
      xlim(.01,max(x_non_zero))+ylim(.01,max(y_non_zero)) +
      labs(x = gene1,y = gene2) +
      theme_light(base_line_size = 0) +
      stat_cor(method = "pearson", size=5, color = "red", geom = "label") +
      theme(axis.title = element_text(size = 20,face = 'bold'),
         axis.text = element_text(size = 15,face = 'bold'))
  
    # Save the plot
    file_name <- paste("HumanA_",  gene1, "_vs_", gene2, ".png", sep = "")
    ggsave(file_name, sc)
    }
    if (length(x_non_zero)>2){
       c <- cor.test(x_non_zero, y_non_zero,method = "pearson")
       p_value_matrix[i, j] <- c$p.value
       cor_matrix[i, j] <- c$estimate
    }
  }
}
rownames(p_value_matrix) = rownames(cor_matrix) = colnames(p_value_matrix) = colnames(cor_matrix) = colnames(humanA)
```

## Visualization_BranchA_human

```{r}
p_value <- p_value_matrix
p_value[upper.tri(p_value,diag =T)] <- NA
corr <- cor_matrix
corr[upper.tri(corr,diag =T)] <- NA
p_value_r = na.omit(melt(p_value))
corr_r = na.omit(melt(corr))
p_val_corr <- merge(p_value_r,corr_r,by = c("Var1","Var2"))
colnames(p_val_corr) = c("gene1","gene2","P-Value","Corr")
p_val_corr$L10p = round(-log10(p_val_corr$`P-Value`),1)
gh = ggplot(p_val_corr)+
  geom_tile(aes(x=gene1,y=gene2, fill = Corr),colour = "black", show.legend = TRUE) +
  geom_text(aes(x=gene1,y=gene2, label=ifelse(!is.na(L10p),paste0("10^-",L10p),NA)),
            parse = T,size=6,fontface="bold")+
  scale_fill_gradient2(mid="white",limits=c(-1,1),na.value = 'gray80',
                       high="#DC0000B2", low="#3C5488B2") +
 theme_test() + 
  ggtitle("Human_Branch A, Number of Cells = 365") +
  theme(axis.title = element_blank(),
        axis.text = element_text( face = "bold",size = 14),
        legend.position = "bottom",
        legend.title = element_text( face = "bold",size = 12),
        legend.text = element_text( face = "bold",size = 10),
        plot.title = element_text(hjust = 0.5, margin = margin(b = 5), face = "bold",size = 14 ))

```
